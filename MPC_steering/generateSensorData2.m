function [allData, scenario, sensor] = generateSensorData2()
%generateSensorData - Returns sensor detections
%    allData = generateSensorData returns sensor detections in a structure
%    with time for an internally defined scenario and sensor suite.
%
%    [allData, scenario, sensors] = generateSensorData optionally returns
%    the drivingScenario and detection generator objects.

% Generated by MATLAB(R) 9.9 (R2020b) and Automated Driving Toolbox 3.2 (R2020b).
% Generated on: 10-Oct-2021 18:16:33

% Create the drivingScenario object and ego car
[scenario, egoVehicle] = createDrivingScenario;

% Create all the sensors
sensor = createSensor(scenario);

allData = struct('Time', {}, 'ActorPoses', {}, 'ObjectDetections', {}, 'LaneDetections', {}, 'PointClouds', {});
running = true;
while running
    
    % Generate the target poses of all actors relative to the ego vehicle
    poses = targetPoses(egoVehicle);
    time  = scenario.SimulationTime;
    
    % Generate detections for the sensor
    laneDetections = [];
    ptClouds = [];
    [objectDetections, numObjects, isValidTime] = sensor(poses, time);
    objectDetections = objectDetections(1:numObjects);
    
    % Aggregate all detections into a structure for later use
    if isValidTime
        allData(end + 1) = struct( ...
            'Time',       scenario.SimulationTime, ...
            'ActorPoses', actorPoses(scenario), ...
            'ObjectDetections', {objectDetections}, ...
            'LaneDetections', {laneDetections}, ...
            'PointClouds',   {ptClouds}); %#ok<AGROW>
    end
    
    % Advance the scenario one time step and exit the loop if the scenario is complete
    running = advance(scenario);
end

% Restart the driving scenario to return the actors to their initial positions.
restart(scenario);

% Release the sensor object so it can be used again.
release(sensor);

%%%%%%%%%%%%%%%%%%%%
% Helper functions %
%%%%%%%%%%%%%%%%%%%%

% Units used in createSensors and createDrivingScenario
% Distance/Position - meters
% Speed             - meters/second
% Angles            - degrees
% RCS Pattern       - dBsm

function sensor = createSensor(scenario)
% createSensors Returns all sensor objects to generate detections

% Assign into each sensor the physical and radar profiles for all actors
profiles = actorProfiles(scenario);
sensor = visionDetectionGenerator('SensorIndex', 1, ...
    'SensorLocation', [1.9 0], ...
    'DetectorOutput', 'Objects only', ...
    'ActorProfiles', profiles);

function [scenario, egoVehicle] = createDrivingScenario
% createDrivingScenario Returns the drivingScenario defined in the Designer

% Construct a drivingScenario object.
scenario = drivingScenario;

% Add all road segments
roadCenters = [-0.03 0.07 0;
    0.04 -6.29 0;
    0.04 -11.83 0;
    0.6 -15.13 0;
    1.28 -19.37 0;
    2.34 -24.1 0;
    3.21 -28.28 0;
    4.4 -33.08 0;
    5.96 -38.56 0;
    8.76 -44.91 0;
    12.8 -52.5 0;
    18.6 -61.9 0;
    26.7 -71.1 0;
    32.5 -76.1 0;
    40.9 -80 0;
    50.8 -81.9 0;
    63.3 -84.3 0;
    76.8 -85.4 0;
    91.3 -81.6 0;
    98.9 -78.1 0;
    115.3 -70.6 0;
    127.5 -60.5 0;
    136.4 -53.7 0;
    152.6 -47.6 0;
    168.2 -43.5 0;
    181.1 -37.4 0;
    185.9 -27.9 0;
    192 -19.8 0;
    195.4 -9.6 0;
    199.4 6.7 0;
    198.8 14.2 0;
    196.7 23.7 0;
    192 29.8 0;
    185.2 39.9 0;
    178.4 50.1 0;
    171 56.2 0;
    162.1 63.7 0;
    156.7 71.8 0;
    153.3 82.7 0;
    150.6 102.3 0;
    149.9 119.3 0;
    149.9 130.1 0;
    144.5 148.5 0;
    139.1 155.2 0;
    128.9 175.6 0;
    122.1 183.1 0;
    110.6 195.3 0;
    100.4 221 0;
    89.6 225.1 0;
    78 229.2 0;
    69.9 229.2 0;
    63.8 222.4 0;
    54.3 213.6 0;
    50.2 208.1 0;
    40.7 204.8 0;
    25.8 211.5 0;
    15 225.8 0;
    4.8 229.9 0;
    -6.1 229.9 0;
    -16.9 229.9 0;
    -24.4 219.7 0;
    -24.4 208.8 0;
    -25.1 202 0;
    -25.1 189.8 0;
    -20.3 168.1 0;
    -15.6 160 0;
    -10.1 152.5 0;
    -6.8 146.4 0;
    0 135.6 0;
    3.4 115.9 0;
    2.7 107.8 0;
    -7.4 90.8 0;
    -8.1 79.3 0;
    -8.8 65 0;
    -7.4 58.2 0;
    -6.8 41.3 0;
    -5.4 29.7 0;
    -2.5 14.1 0;
    -0.5 7.5 0;
    0 3.9 0;
    -0.03 0.07 0];
road(scenario, roadCenters, 'Name', 'Road');

% Add the ego vehicle
egoVehicle = vehicle(scenario, ...
    'ClassID', 1, ...
    'Position', [-0.0092750159379318 0.5 0.01], ...
    'Mesh', driving.scenario.carMesh, ...
    'Name', 'Car');
waypoints = [-0.0092750159379318 0.5 0.01;
    -0.0200000000000102 6 0.01;
    -0.06 8.5 0.01;
    -0.0200000000000102 11.2 0.01;
    -0.0200000000000102 12.2 0.01;
    0.49 13.1 0.01;
    1.04 14.05 0.01;
    1.59 14.5 0.01;
    2.11000000000001 14.85 0.01;
    3.08000000000001 14.99 0.01;
    3.56 15.1 0.01;
    4.13999999999999 15.21 0.01;
    4.81999999999999 15.35 0.01;
    5.69 15.405 0.01;
    6.84999999999999 15.65 0.01;
    7.91999999999999 15.74 0.01;
    8.78999999999999 15.92 0.01;
    9.66 15.95 0.01;
    10.61 16 0.01;
    11.81 16 0.01;
    12.69 16 0.01;
    13.95 16 0.01;
    15.65 16 0.01;
    16.96 16 0.01;
    18.28 16.2 0.01;
    19.37 16.5 0.01;
    21.45 16.4 0.01;
    23.37 16.3 0.01;
    25.01 16.22 0.01;
    26.76 16.2 0.01;
    28.35 16.2 0.01;
    30.38 16.15 0.01;
    32.07 16.1 0.01;
    33.5 16.1 0.01;
    35.52 16.05 0.01;
    38.7 16.02 0.01;
    42 16 0;
    46.4 15.8 0;
    52.1 15.8 0;
    57 15.63 0;
    63.4 15.55 0;
    68.4 15.5 0;
    73.09 15.5 0.01;
    76.73 15.8 0.01;
    80.4 16.2 0;
    82.8 16.4 0;
    85.4 16.6 0;
    89.4 16.85 0;
    92.9 16.5 0;
    96.3 16.35 0;
    101.4 16.3 0;
    105.2 16.3 0;
    109.2 16.3 0;
    113.6 16.2 0;
    117.7 16 0;
    120.7 16 0;
    124 16.2 0;
    127.8 16.4 0;
    131.5 16.8 0;
    136 17.2 0;
    140.4 17.5 0;
    147.5 18.1 0;
    154.8 18.5 0;
    162.5 18.85 0;
    171.4 19 0;
    178.8 18.2 0;
    181.89 17.5 0.01;
    185.06 17.1 0.01;
    188.9 17 0;
    192 17.3 0;
    194.4 17.55 0;
    196.1 17.95 0;
    197.7 18.35 0;
    199.1 18.85 0;
    199.9 19.25 0;
    199.62 19.75 0.01;
    199.32 20.25 0.01;
    199.02 21 0.01;
    198.64 21.52 0.01;
    197.6 22.15 0;
    196.5 22.85 0;
    195.4 23.25 0.01;
    193.58 24.05 0.01;
    191.9 24.75 0.01;
    189.8 25.12 0;
    186.73 25.75 0.01;
    184.4 26 0;
    182.7 25.2 0;
    181.5 24.6 0;
    178.93 23.05 0.01;
    176 23 0;
    172.2 23 0;
    167.5 23 0;
    162.2 23 0;
    159.5 23 0;
    157 23 0;
    155.2 23 0;
    153.7 23.5 0;
    152.72 23.95 0.01;
    151.8 24.45 0;
    151.19 24.9 0.01;
    150.9 25.35 0;
    150.61 26 0.01;
    150.49 26.2 0.01;
    150.4 26.85 0.01;
    150.4 27.4 0;
    150.4 27.2 0;
    150.1 26.5 0;
    148.4 26.15 0;
    146.69 25.75 0.01;
    143.9 25.2 0;
    139.7 25 0;
    135.45 24.85 0.01;
    132.71 24.5 0.01;
    129.51 24.2 0.01;
    125.18 24.2 0.01;
    121.49 24.25 0.01;
    117.1 24.3 0;
    113.26 24.3 0.01;
    110.9 24.2 0;
    108.8 24.05 0;
    107.4 23.7 0;
    106 22.95 0;
    104.76 22.5 0.01;
    102.53 22 0.01;
    98.69 22 0.01;
    95.41 22 0.01;
    88.93 22 0.01;
    84.46 21.7 0.01;
    79.85 21.35 0.01;
    77.32 20.2 0.01;
    74.97 19.1 0.01;
    72.29 18.02 0.01;
    69.77 17.25 0.01;
    68.12 16.4 0.01;
    66.2 15.75 0;
    64.2 15.5 0;
    61.5 15.5 0;
    59.2 15.5 0;
    55.9 15.5 0;
    54.2 15.5 0;
    53.3 15.5 0;
    50.99 15.25 0.01;
    48.8 15.15 0;
    44.6 15 0;
    39.9 14.85 0;
    34.7 14.6 0;
    30 14.35 0;
    26.54 14.3 0.01;
    23.76 14.3 0.01;
    21.68 14.2 0.01;
    20.1 14.2 0;
    17.6 14.2 0;
    14.81 14.2 0.01;
    11.3 14.2 0;
    6 14.2 0;
    1.69 14.6 0.01;
    -2.4 14.8 0.01;
    -7.41 15 0.01;
    -11.5 15 0.01;
    -16.44 14.7 0.01;
    -19.9 14.26 0;
    -23.6 13.9 0;
    -25.3 13.5 0;
    -25.23 13.2 0.01;
    -25 13.2 0.01;
    -25.38 13.2 0.01;
    -25.86 13.5 0.01;
    -25.84 13.9 0.01;
    -25.54 14.4 0.01;
    -24.11 15.1 0.01;
    -22.21 15.89 0.01;
    -19.4 16.3 0;
    -16.2 17.1 0;
    -12.9 17.95 0;
    -9.90000000000001 18.45 0;
    -7.09999999999999 18.76 0;
    -4.09999999999999 19.25 0;
    -2 19.78 0;
    -0.199999999999989 20.35 0;
    2 21.05 0;
    2.9 21.85 0;
    3.7 22.35 0;
    4 23.1 0;
    3.69999999999999 22.15 0;
    2.90000000000001 21.35 0;
    1 24.4 0;
    -2.44 19.45 0.01;
    -5.16 18.75 0.01;
    -6.80000000000001 18.1 0;
    -8.30000000000001 17.45 0;
    -8.30000000000001 16.84 0;
    -9 16.5 0;
    -9.19999999999999 16.5 0;
    -9.16 16.5 0.01;
    -8.94 16.95 0.01;
    -8.5 17.35 0;
    -8.09999999999999 17.85 0;
    -7.5 18.23 0;
    -7.19999999999999 18.45 0;
    -7.05 18.76 0.01;
    -6.75 19.05 0.01;
    -6.07 19.15 0.01;
    -5.30000000000001 19.2 0;
    -4.80000000000001 19.2 0;
    -3.5 19.1 0;
    -2.40000000000001 19 0;
    -1.19999999999999 18.8 0;
    -0.199999999999989 18 0;
    0.05 18.5 0.01];
speed = [9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73;9.73];
yaw =  [NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;-1.6174065120408;NaN;NaN;-4.71128163555539;3.26556266227231;4.95176728383176;10.5836658269317;12.5653117500622;20.768631896171;6.56745416011657;84.8327221627582;130.482161724522;113.389107878635;116.407338466355;137.010246163252;149.840540524138;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;156.510535857618;153.535878990556;149.714912985712;132.373868888294;115.147853913245;119.436120065897;120.12594960019;62.4744370467244;-123.716988760766;-78.5960491542219;-141.183836496276;-174.977912226068;-164.26402315082;-173.164481372355;-179.507707787528;-174.556696186184;-172.49954588449;-177.311316312968;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;NaN;-177.960398269215;-178.52007306262;179.512194544507;-179.82227047122;179.792237623;-179.285306821975;176.725231416271;175.40697751742;177.527470489075;179.482179637594;178.303087249415;-161.954507857714;-155.112140043713;192.294800304305;-989.980348755513;24.1391787935167;-49.4421369061053;125.554389554911;-88.196562181707;-88.883294168072;-88.0025035325788;24.9042708127492;15.8826489802663;8.40385476368519;16.2620851384396;12.0251773064527;7.03184724313068;7.017517564237;11.5128702189412;17.8903254819445;12.7482736077837;39.0681408933913;27.1373891645388;67.447071959776;9.42581674863206;-139.301733012911;-157.724929411466;140.881567294714;-142.81018683666;-161.363625925993;-171.822586869168;-93.3609751482113;-121.136057905115;-136.045107279977;14.1089596852573;-2.53321172987682;70.7856113059231;40.5566927804935;46.5092656517297;26.7905012029244;53.6351682741627;62.0536409753861;26.1530336367257;1.81646785522324;2.35171226853252;-1.70542358707702;-7.02275046835266;0.629455053678254;-41.0245047803798;27.8858990566134;81.0120314140333];
trajectory(egoVehicle, waypoints, speed, 'Yaw', yaw);

